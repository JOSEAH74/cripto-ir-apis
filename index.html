async function puxarTudo() {
  const key = document.getElementById('apiKey').value.trim();
  const secret = document.getElementById('apiSecret').value.trim();
  const inicio = document.getElementById('dataInicio').value;
  const debug = document.getElementById('debug');
  debug.style.display = 'block';
  debug.innerHTML = '<p>Iniciando...</p>';

  if (!key || !secret) {
    debug.innerHTML += '<p style="color:red;">Preencha Key e Secret!</p>';
    return;
  }

  trades = [];
  for (const pair of pares) {
    debug.innerHTML += `<p>--- ${pair} ---</p>`;
    const url = `/.netlify/functions/mb?key=${key}&secret=${secret}&pair=${pair}`;
    
    try {
      const res = await fetch(url);
      const text = await res.text();
      debug.innerHTML += `<p>Status: ${res.status}</p>`;
      
      if (!res.ok) {
        debug.innerHTML += `<p style="color:orange;">Erro: ${text}</p>`;
        continue;
      }

      let data;
      try { data = JSON.parse(text); } catch (e) { 
        debug.innerHTML += `<p style="color:orange;">JSON inválido: ${text}</p>`;
        continue;
      }

      if (!Array.isArray(data)) {
        debug.innerHTML += `<p style="color:orange;">Não é array: ${JSON.stringify(data)}</p>`;
        continue;
      }

      const filtered = data
        .filter(t => t.date && t.type && t.amount && t.price)
        .map(t => {
          const d = t.date.split(' ')[0];
          return {
            data: d,
            tipo: t.type.toLowerCase(),
            par: pair.replace('BRL', '/BRL'),
            qtd: parseFloat(t.amount),
            preco: parseFloat(t.price),
            total: parseFloat(t.amount) * parseFloat(t.price)
          };
        })
        .filter(t => !inicio || t.data >= inicio);

      trades = trades.concat(filtered);
      debug.innerHTML += `<p>Trades: ${filtered.length}</p>`;
    } catch (err) {
      debug.innerHTML += `<p style="color:red;">Erro fetch: ${err.message}</p>`;
    }
  }

  if (trades.length === 0) {
    debug.innerHTML += '<p style="color:orange;">Nenhuma negociação encontrada.</p>';
  } else {
    mostrarResultados();
    document.getElementById('darfBtn').style.display = 'block';
  }
}